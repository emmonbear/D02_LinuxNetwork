# Сети в Linux

## Содержание

1. [Part 1. Инструмент ipcalc](#part-1-инструмент-ipcalc)
2. [Part 2. Статическая маршрутизация между двумя машинами](#part-2-статическая-маршрутизация-между-двумя-машинами)
3. [Part 3. Утилита iperf3](#part-3-утилита-iperf3)
4. [Part 4. Сетевой экран](#part-4-сетевой-экран)
5. [Part 5. Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети)
6. [Part 6. Динамическая настройка IP с помощью DHCP](#part-6-динамическая-настройка-ip-с-помощью-dhcp)
7. [Part 7. NAT](#part-7-nat)
8. [Part 8. Дополнительно. Знакомство с SSH Tunnels](#part-8-дополнительно-знакомство-с-ssh-tunnels)

## Part 1. Инструмент ipcalc

Скачать утилиту **ipcalc**: `sudo apt install ipcalc`<br>
1. Сети и маски.<br>
    Определить и записать в отчет:<br>
    1. адрес сети **192.167.38.54/13**:<br>
        * `ipcalc 192.167.38.54/13`<br>
        ![part 1.1.1](screenshots/1.png)<br>
        **Адрес сети**: 192.160.0.0/13 <br>

    2. перевод маски **255.255.255.0** в префиксную и двоичную запись, **/15** в обычную и двоичную, **11111111.11111111.11111111.11110000** в обычную и префиксную:<br>
        1. перевод маски **255.255.255.0** в префиксную и двоичную запись:<br>
            * `ipcalc 255.255.255.0`<br>
            ![part 1.1.2](screenshots/2.png)<br>
            **Префисная запись**: 24<br>
            **Двоичная запись**: 11111111.11111111.11111111.00000000<br>
        2. перевод **/15** в обычную и двоичную запись:<br>
            * `ipcalc /15`<br>
            ![part 1.1.3](screenshots/3.png)<br>
            **Обычная запись**: 255.254.0.0<br>
            **Двоичная запись**: 11111111.11111111.00000000.00000000<br>
        3. перевод **11111111.11111111.11111111.11110000** в обычную и префиксную::<br>
            * `ipcalc /28`<br>
            ![part 1.1.4](screenshots/4.png)<br>
            **Обычная запись**: 255.255.255.240<br>
            **Префиксная запись**: 28<br>
    3. минимальный и максимальный хост в сети **12.167.38.4** при масках: **/8**, **11111111.11111111.00000000.00000000**, **255.255.254.0** и **/4**<br>
        1. минимальный и максимальный хост в сети **12.167.38.4/8**<br>
            * `ipcalc 12.167.38.4/8`<br>
            ![part 1.1.5](screenshots/5.png)<br>
            **минимальный хост**: 12.0.0.0/8<br>
            **максимальный хост**: 12.255.255.254<br>
        2. минимальный и максимальный хост в сети **12.167.38.4/16** (маска 11111111.11111111.00000000.00000000)<br>
            * `ipcalc 12.167.38.4/16`<br>
            ![part 1.1.6](screenshots/6.png)<br>
            **минимальный хост**: 12.167.0.1<br>
            **максимальный хост**: 12.167.255.254<br>
        3. минимальный и максимальный хост в сети **12.167.38.4/23** (маска 255.255.254.0)<br>
            * `ipcalc 12.167.38.4/23`<br>
            ![part 1.1.7](screenshots/7.png)<br>
            **минимальный хост**: 12.167.38.1<br>
            **максимальный хост**: 12.167.39.254<br>
        4. минимальный и максимальный хост в сети **12.167.38.4/4**<br>
            * `ipcalc 12.167.38.4/4`<br>
            ![part 1.1.8](screenshots/8.png)<br>
            **минимальный хост**: 0.0.0.1<br>
            **максимальный хост**: 15.255.255.254<br>

2. localhost.<br>
    Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: **194.34.23.100**, **127.0.0.2**, **127.1.0.1**, **128.0.0.1**:<br>
    * Адрес **127.0.0.0** – **127.255.255.255** (loopback – петля на себя).   Данная сеть нужна для диагностики, соответственно, мы можем обратиться к приложению, работающему на этом хосте<br>
    Остальные IP-адреса зарезервированы для частых (локальных) сетей<br>
    ![part 1.2.1](screenshots/9.png)<br>
3. Диапазоны и сегменты сетей<br>
    Определить и записать в отчёт:<br>
    1. какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: **10.0.0.45**, **134.43.0.2**, **192.168.4.2**, **172.20.250.4**, **172.0.2.1**, **192.172.0.1**, **172.68.0.2**, **172.16.255.255**, **10.10.10.10**, **192.169.168.1**<br>
        1. Публичные IP-адреса:<br>
            * 134.43.0.2<br>
            * 172.0.2.1<br>
            * 192.172.0.1<br>
            * 172.68.0.2<br>
            * 192.169.168.1<br>
        2. Частные IP-адреса:<br>
            * 10.0.0.45<br>
            * 192.168.4.2<br>
            * 172.20.250.4<br>
            * 10.10.10.10<br>
    2. какие из перечисленных IP адресов шлюза возможны у сети **10.10.0.0/18**: **10.0.0.1**, **10.10.0.2**, **10.10.10.10**, **10.10.100.1**, **10.10.1.255**<br>
        ![part 1.3.1](screenshots/10.png)<br>
        * Исходя из HostMin: **10.10.0.1** и HostMax: **10.10.63.254** возможные IP шлюзы: **10.10.0.2**, **10.10.10.10**, **10.10.1.255**<br>

## Part 2. Статическая маршрутизация между двумя машинами

P.S. Во избежание проблем с заданием  необходимо настроить VirtualBox: Добавить на машинах сетевой адаптер 2 (сетевой мост).<br>

Поднять две виртуальные машины (далее -- **ws1** и **ws2**).<br>

С помощью команды `ip a` посмотреть существующие сетевые интерфейсы<br>

* В отчёт поместить скрин с вызовом и выводом использованной команды<br>
![part 2.0.1](screenshots/11.png)<br>
![part 2.0.2](screenshots/12.png)<br>

Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - **192.168.100.10**, маска **/16**, ws2 - **172.24.116.8**, маска **/12**<br>

* В отчёт поместить скрины с содержанием изменённого файла **etc/netplan/00-installer-config.yaml** для каждой машины.<br>
![part 2.0.3](screenshots/13.png)<br>
![part 2.0.4](screenshots/14.png)<br>

Выполнить команду `netplan apply` для перезапуска сервиса сети<br>

* В отчёт поместить скрин с вызовом и выводом использованной команды.<br>
![part 2.0.5](screenshots/15.png)<br>
![part 2.0.6](screenshots/16.png)<br>
---
1. Добавление статического маршрута вручную<br>

    1. Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`<br>
    ![part 2.1.1](screenshots/17.png)<br>
    ![part 2.1.2](screenshots/18.png)<br>

    2. Пропинговать соединение между машинами<br>
    ![part 2.1.3](screenshots/19.png)<br>
    ![part 2.1.4](screenshots/20.png)<br>

2. Добавление статического маршрута с сохранением<br>

    Перезапустить машины:<br>
    `reboot`<br>
    1. Добавить статический маршрут от одной машины до другой с помощью файла **etc/netplan/00-installer-config.yaml**:<br>
    ![part 2.2.1](screenshots/21.png)<br>
    ![part 2.2.2](screenshots/22.png)<br>

    2. Пропинговать соединение между машинами:<br>
    Выполнить команду `sudo netplan apply`.<br>
    ![part 2.2.3](screenshots/23.png)<br>
    ![part 2.2.4](screenshots/24.png)<br>

## Part 3. Утилита iperf3

1. Скорость соединения:<br>
    * Перевести и записать в отчёт: **8 Mbps** в **MB/s****, **100 MB/s** в **Kbps**, **1 Gbps** в **Mbps**<br>
        * 8 Mbps = 1 MB/s;<br>
        * 100 MB/s = 800000 Kbps;<br>
        * 1 Gbps = 1000 Mbps;<br>
    
2. Утилита iperf3:<br>
    * Измерить скорость соединения между ws1 и ws2:<br>
        ![part 2.3.1](screenshots/25.png)<br>
        ![part 2.3.2](screenshots/26.png)<br>

## Part 4. Сетевой экран

1. Утилита iptables.<br>
    * Создать файл **/etc/firewall.sh**, имитирующий фаерволл, на ws1 и ws2:<br>
    `vim /etc/firewall.sh`<br>
    * Нужно добавить в файл подряд следующие правила:<br>
        1. на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5);<br>
        2. на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5);<br>
        3. открыть на машинах доступ для порта 22 (ssh) и порта 80 (http);<br>
        4. запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT);<br>
        5. разрешить echo reply (машина должна "пинговаться");<br>

    * В отчёт поместить скрины с содержанием файла /etc/firewall для каждой машины:<br>
        ![part 4.1.1](screenshots/27.png)<br>
        ![part 4.1.2](screenshots/28.png)<br>
        Пояснение каждой команде:<br>
        `iptables -F`: очищает все существующие правила в настройках брандмауэра iptables. Это позволяет сбросить настройки брандмауэра до значений по умолчанию;<br>
        `iptables -X`: используется для удаления (или очистки) всех пользовательских цепочек в конфигурации файрвола iptables;<br>
        `iptables -A INPUT -p tcp --dport 22(80) -j ACCEPT`: эта команда добавляет правило в цепь INPUT (входящий трафик), разрешая входящие TCP-соединения на порту 22 (SSH) с помощью флага -j ACCEPT;<br>
        `iptables -A OUTPUT -p icmp --icmp-type echo-reply -j DROP`:
        эта команда используется для блокировки ответов на пинг. Добавляется правило в ветвь OUTPUT, которое блокирует отправку ICMP-пакетов типа echo-reply (ответ на пинг);<br>
        `iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT`: эта команда добавляет правило в цепь OUTPUT, разрешая отправку исходящих ICMP-пакетов типа echo-reply (ответ на пинг);<br>
        `/sbin/iptables-save`: эта команда сохраняет текущую конфигурацию брандмауэра iptables, чтобы она смогла пережить перезагрузку системы;<br>

    * Запустить файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`<br>

        1. В отчёт поместить скрины с запуском обоих файлов:<br>
            ![part 4.1.3](screenshots/29.png)<br>
            ![part 4.1.4](screenshots/30.png)<br>
        2. В отчёте описать разницу между стратегиями, применёнными в первом и втором файлах:<br>
            * Разница между стратегиями, применяемыми в файлах ws1 и ws2, заключается в порядке применения разрешающих и запрещающих правил. В ws1 сначала устанавливается запрещающее правило, а затем следуют разрешающее. Это означает, что все входящие пакеты будут отброшены, кроме тех, которые соответствуют разрешительным правилам (SSH, HTTP, ICMP). В ws2 происходит наоборот — сначала задается разрешающее правило, а уже потом запрещающее. Это означает, что будут приняты все входящие пакеты, кроме тех, которые соответствуют запрещающим правилам (SSH, HTTP, ICMP). Таким образом, машина ws1 не будет пинговаться, а ws2 пингуется.<br>
            
2. Утилита **nmap**.<br>

    Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен (Проверка: в выводе nmap должно быть сказано: Host is up);<br>
    ![part 4.2.1](screenshots/31.png)<br>
    ![part 4.2.2](screenshots/32.png)<br>
    ![part 4.2.3](screenshots/33.png)<br>

## Part 5. Статическая маршрутизация сети

Сеть:<br>
![part 5.0.1](screenshots/34.png)<br>

Поднять пять виртуальных машин (3 рабочие станции (**ws11**, **ws21**, **ws22**) и 2 роутера (**r1**, **r2**))<br>

1. Настройка адресов машин:<br>
    Настроить конфигурации машин в **etc/netplan/00-installer-config.yaml** согласно сети на рисунке.<br>
    * В настройках машин в VirtualBox поменять настройки сети:<br>
        1.  Для ws11, ws21, ws22:
            * Адаптер 1: NAT;<br>
            * Адаптер 2: Внутренняя сеть;<br>
        2. Для r1, r2:
            * Адаптер 1: NAT;<br>
            * Адаптер 2: Внутренняя сеть;<br>
            * Адаптер 3: Внутренняя сеть;<br>
    * В отчёт поместить скрины с содержанием файла etc/netplan/00-installer-config.yaml для каждой машины:<br>
        1. ws11:<br>
        ![part 5.1.1](screenshots/35.png)<br>
        2. ws21:<br>
        ![part 5.1.2](screenshots/36.png)<br>
        3. ws22:<br>
        ![part 5.1.3](screenshots/37.png)<br>
        4. r1:<br>
        ![part 5.1.4](screenshots/38.png)<br>
        5. r2:<br>
        ![part 5.1.5](screenshots/39.png)<br>

    Перезапустить сервис сети. Если ошибок нет, то командой `ip -4 a` проверить, что адрес машины задан верно.<br>
    * В отчёт поместить скрины с вызовом и выводом использованных команд:<br>
        1. ws11:<br>
        ![part 5.1.6](screenshots/40.png)<br>
        2. ws21:<br>
        ![part 5.1.7](screenshots/41.png)<br>
        3. ws22:<br>
        ![part 5.1.8](screenshots/42.png)<br>
        4. r1:<br>
        ![part 5.1.9](screenshots/43.png)<br>
        5. r2:<br>
        ![part 5.1.10](screenshots/44.png)<br>

    Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.<br>
    1. ws22 с ws21:<br>
    ![part 5.1.11](screenshots/45.png)<br>
    2. r1 с ws11:<br>
    ![part 5.1.12](screenshots/46.png)<br>

2. Включение переадресации IP-адресов:<br>
    Для включения переадресации IP, выполните команду на роутерах:<br>
    `sysctl -w net.ipv4.ip_forward=1`<br>
    При таком подходе переадресация не будет работать после перезагрузки системы.
    * В отчёт поместить скрин с вызовом и выводом использованной команды:<br>
        1. r1:<br>
        ![part 5.2.4](screenshots/50.png)<br>
        2. r2:<br>
        ![part 5.2.5](screenshots/51.png)<br>

    Откройте файл **/etc/sysctl.conf**  и добавьте в него следующую строку:<br>
    `net.ipv4.ip_forward = 1`<br>
    При использовании этого подхода, IP-переадресация включена на постоянной основе.<br>
    * В отчёт поместить скрин с содержанием изменённого файла /etc/sysctl.conf:<br>
    ![part 5.2.6](screenshots/52.png)<br>

3. Установка маршрута по-умолчанию:<br>
    Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить default перед IP роутера в файле конфигураций<br>
    * В отчёт поместить скрин с содержанием файла **etc/netplan/00-installer-config.yaml**:
        1. ws11:<br>
        ![part 5.3.1](screenshots/53.png)<br>
        2. ws21:<br>
        ![part 5.3.2](screenshots/54.png)<br>
        3. ws22:<br>
        ![part 5.3.3](screenshots/55.png)<br>

    Принять изменения: `sudo netplan apply`;<br>
    Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации:<br>
    * В отчёт поместить скрин с вызовом и выводом использованной команды:<br>
        1. ws11:<br>
        ![part 5.3.4](screenshots/56.png)<br>
        2. ws21:<br>
        ![part 5.3.5](screenshots/57.png)<br>
        3. ws22:<br>
        ![part 5.3.6](screenshots/58.png)<br>

    Пропинговать с **ws11** роутер **r2** и показать на **r2**, что пинг доходит. Для этого использовать команду: `tcpdump -tn -i eth1`<br>
    * В отчёт поместить скрин с вызовом и выводом использованных команд.
        1. пропинговать с **ws11** роутер **r2**<br>
        ![part 5.3.7](screenshots/59.png)<br>
        2. показать на **r2**, что пинг доходит<br>
        ![part 5.3.8](screenshots/60.png)<br>

4. Добавление статических маршрутов<br>
    Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций:<br>
    * В отчёт поместить скрины с содержанием изменённого файла **etc/netplan/00-installer-config.yaml** для каждого роутера:<br>
        1. r1:<br>
        ![part 5.4.1](screenshots/61.png)<br>
        2. r2:<br>
        ![part 5.4.2](screenshots/62.png)<br>

    Вызвать ip r и показать таблицы с маршрутами на обоих роутерах:
    * В отчёт поместить скрин с вызовом и выводом использованной команды:<br>
        1. r1:<br>
        ![part 5.4.3](screenshots/63.png)<br>
        2. r2:<br>
        ![part 5.4.4](screenshots/64.png)<br>

    Запустить команды на ws11:<br>
    `ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`<br>
    * В отчёт поместить скрин с вызовом и выводом использованных команд:
    ![part 5.4.5](screenshots/65.png)<br>
    * В отчёте объяснить, почему для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию:<br>
        * Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, потому что 0.0.0.0/0 будет выбран в том случае, когда другой маршрут не задан в таблице маршрутизации хоста. ws11 находится внутри сети 10.10.0.0/18, и для связи с ней используется IP-адрес 10.10.0.2, поэтому ws11 отправляет данные на роутер, используя маршрут по умолчанию.<br>
    
    5. Построение списка маршрутизаторов:<br>
        1.  Запустить на **r1** команду дампа:<br>
        `tcpdump -tnv -i eth0`<br>
        2. При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21<br>
            * В отчёт поместить скрины с вызовом и выводом использованных команд (tcpdump и traceroute):<br>
            ![part 5.5.1](screenshots/66.png)<br>
            * В отчёте, опираясь на вывод, полученный из дампа на r1, объяснить принцип работы построения пути при помощи traceroute:<br>
                * Из дампа на r1 видно, что пакет проходит через маршрутизаторы для достижения указанного адреса. На этом основан принцип работы traceroute<br>
                * Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. Причем, каждый пакет имеет свое время жизни. Это количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. Этот параметр записывается в заголовке TTL, каждый маршрутизатор, через который будет проходить пакет уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение Time Exceeded.<br>
                * Команда traceroute linux использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.<br>

    6. Использование протокола ICMP при маршрутизации:<br>
        > **ICMP** (англ. Internet Control Message Protocol — протокол межсетевых управляющих сообщений[1]) — сетевой протокол, входящий в стек протоколов TCP/IP. В основном ICMP используется для передачи сообщений об ошибках и других исключительных ситуациях, возникших при передаче данных<br>
        1. Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:<br>
            * `tcpdump -n -i eth0 icmp`
        2. Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:<br>
            * `ping -c 1 10.30.0.111`<br>
            ![part 5.6.1](screenshots/67.png)<br>
            ![part 5.6.2](screenshots/68.png)<br>

## Part 6. Динамическая настройка IP с помощью DHCP



## Part 7. NAT

## Part 8. Дополнительно. Знакомство с SSH Tunnels





